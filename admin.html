<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Operation Level Up — Admin</title>
<link rel="stylesheet" href="styles.css">
<style>
  body { padding:16px; background:#05060a; color:#fff; font-family:Arial; }
  .panel { max-width:520px; margin:0 auto; }
  .controls button { margin:6px; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; }
  .teamControl { background:#111; margin:8px 0; padding:8px; border-radius:10px;}
  input { padding:8px; border-radius:8px; border:1px solid #333; background:#0b0b0b; color:#fff; }
</style>
</head>
<body>
  <div class="panel">
    <h1>Admin Panel</h1>

    <div class="controls">
      <h3>Game Controls</h3>
      <button onclick="startGame()">START MISSION</button>
      <button onclick="startFreeze(10)">Freeze 10s</button>
      <button onclick="startFreeze(30)">Freeze 30s</button>
      <button onclick="stopFreeze()">Stop Timer</button>
    </div>

    <div style="margin-top:12px;">
      <h3>Round</h3>
      <input id="roundInput" placeholder="Round Name (e.g. Freeze Command)">
      <button onclick="setRound()">Set Round</button>
    </div>

    <div style="margin-top:18px;">
      <h3>Teams</h3>
      <div id="adminTeams"></div>
      <button onclick="addTeam()">+ Add Team</button>
    </div>

    <div style="margin-top:18px;">
      <h3>Session</h3>
      <button onclick="resetGame()">Reset Game (careful)</button>
    </div>
  </div>

<script type="module">
import { db, ref, set, update, onValue, get } from './firebase.js';

const gameRef = ref(db, "game");

const defaultState = {
  phase: "intro",
  round: "Freeze Command",
  timer: { endTime:0, duration:0, active:false },
  lastChange: null,
  lastChangedTeam: null,
  teams: [
    { name: "Red", score: 50, roles: [] },
    { name: "Blue", score: 50, roles: [] },
    { name: "Green", score: 50, roles: [] },
    { name: "Yellow", score: 50, roles: [] }
  ]
};

// Only initialize if game node is empty
async function ensureInit(){
  try {
    const snap = await get(gameRef);
    if(!snap.exists()){
      await set(gameRef, defaultState);
    }
  } catch(e){
    console.error("Firebase init error", e);
  }
}

ensureInit();

onValue(gameRef, snapshot => {
  const data = snapshot.val();
  if(!data) return;
  const container = document.getElementById("adminTeams");
  container.innerHTML = "";
  data.teams.forEach((team, index) => {
    const el = document.createElement("div");
    el.className = "teamControl";
    el.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <input id="name-${index}" value="${team.name}" style="width:140px;">
          <small style="margin-left:8px">Score: ${team.score}</small>
        </div>
        <div>
          <button onclick="change(${index},5)">+5</button>
          <button onclick="change(${index},-5)">-5</button>
          <button onclick="addRole(${index})">Add Role</button>
          <button onclick="rename(${index})">Rename</button>
        </div>
      </div>
      <div style="margin-top:8px;">
        <small>Roles: ${team.roles.join(", ") || '—'}</small>
      </div>
    `;
    container.appendChild(el);
  });
});

// change score (writes lastChange + lastChangedTeam)
window.change = async function(index, amount){
  try {
    const snap = await get(gameRef);
    if(!snap.exists()) return;
    const data = snap.val();
    data.teams[index].score = Math.max(0, Math.min(120, (data.teams[index].score || 0) + amount));
    data.lastChange = amount > 0 ? "gain" : "lose";
    data.lastChangedTeam = index;
    await update(gameRef, data);
  } catch(e){ console.error(e); }
}

window.setRound = async function(){
  const r = document.getElementById("roundInput").value || "Round";
  await update(gameRef, { round: r });
}

// start game (switch phase)
window.startGame = async function(){
  await update(gameRef, { phase: "game" });
}

// freeze timer (writes endTime + duration + active)
window.startFreeze = async function(seconds){
  const end = Date.now() + seconds * 1000;
  await update(gameRef, { timer: { endTime: end, duration: seconds, active: true } });
}

window.stopFreeze = async function(){
  await update(gameRef, { timer: { endTime:0, duration:0, active:false } });
}

window.addRole = async function(index){
  const role = prompt("Enter role name (e.g. Noise Captain):");
  if(!role) return;
  try {
    const snap = await get(gameRef);
    const data = snap.val();
    data.teams[index].roles = data.teams[index].roles || [];
    data.teams[index].roles.push(role);
    await update(gameRef, data);
  } catch(e){ console.error(e); }
}

window.rename = async function(index){
  const nameInput = document.getElementById(`name-${index}`);
  if(!nameInput) return;
  const newName = nameInput.value.trim();
  if(!newName) return;
  try {
    const snap = await get(gameRef);
    const data = snap.val();
    data.teams[index].name = newName;
    await update(gameRef, data);
  } catch(e){ console.error(e); }
}

window.addTeam = async function(){
  const name = prompt("Team name:");
  if(!name) return;
  try {
    const snap = await get(gameRef);
    const data = snap.val();
    data.teams.push({ name, score: 50, roles: [] });
    await update(gameRef, data);
  } catch(e){ console.error(e); }
}

window.resetGame = async function(){
  if(!confirm("Reset game to defaults? This will overwrite current game.")) return;
  await set(gameRef, defaultState);
}

</script>
</body>
</html>
